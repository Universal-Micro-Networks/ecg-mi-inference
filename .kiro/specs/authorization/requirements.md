# 要件定義書: 認可機能 (authorization)

## はじめに

本ドキュメントは、ECG心筋梗塞リスク推論システムにおける認可機能の要件を定義する。
本機能は、医療従事者（循環器内科医、心電図検査技師、診療支援スタッフ）がシステムを利用する際の
アクセス制御を担い、患者データの保護とシステムの不正利用防止を実現する。

**関連ユースケース:** UC-2（システムはユーザー認可（パスワード入力）により利用許可を制御する）

## 要件一覧

### 要件1: ユーザーログイン

**目的:** 医療従事者として、パスワードを入力してシステムにログインしたい。
これにより、認可されたユーザーのみが患者データや推論機能にアクセスできるようにする。

#### 受け入れ基準

1. When ユーザーがログイン画面にアクセスする, 認可機能 shall パスワードの入力フォームを表示する
2. When ユーザーが正しいパスワードを入力して送信する, 認可機能 shall ユーザーを認可しダッシュボードへリダイレクトする
3. When ユーザーが正しいパスワードを入力して送信する, 認可機能 shall 認可トークン（JWT）を発行しセッションを開始する
4. If 誤ったパスワードが入力された場合, then 認可機能 shall 「パスワードが正しくありません」というエラーメッセージを表示する
5. If 誤ったパスワードが入力された場合, then 認可機能 shall 入力されたパスワードをクリアする
6. The 認可機能 shall パスワードをbcryptでハッシュ化して保存する

### 要件2: セッション管理

**目的:** システム管理者として、ユーザーセッションを適切に管理したい。
これにより、セキュリティを維持しつつユーザーの利便性を確保する。

#### 受け入れ基準

1. When ユーザーが認可に成功する, 認可機能 shall 有効期限付きのアクセストークンを発行する
2. While ユーザーがアクティブにシステムを使用している, 認可機能 shall セッションの有効期限を延長する
3. When セッションの有効期限が切れる, 認可機能 shall ユーザーをパスワード入力画面へリダイレクトする
4. When セッションの有効期限が切れる, 認可機能 shall 「セッションの有効期限が切れました。再度ログインしてください」というメッセージを表示する
5. 認可機能 shall アクセストークンの有効期限を8時間に設定する
6. 認可機能 shall リフレッシュトークンの有効期限を24時間に設定する

### 要件3: アクセス制御

**目的:** 医療従事者として、認可済みの状態でのみ患者データや推論機能にアクセスしたい。
これにより、患者データの機密性を保護する。

#### 受け入れ基準

1. When 未認可ユーザーが保護されたページにアクセスする, 認可機能 shall ユーザーをパスワード入力画面へリダイレクトする
2. When 認可済みユーザーがAPIエンドポイントにリクエストする, 認可機能 shall リクエストヘッダーの認可トークンを検証する
3. If 無効または期限切れのトークンでAPIリクエストが行われた場合, then the 認可機能 shall HTTP 401 Unauthorizedレスポンスを返す
4. 認可機能 shall すべてのAPIエンドポイント（ログインエンドポイントを除く）に認可を要求する
5. フロントエンド shall 認可状態をグローバルに管理し、未認可時は保護されたルートへのアクセスを防止する

### 要件4: ログアウト

**目的:** 医療従事者として、システムからログアウトしたい。
これにより、共有端末使用時などにセキュリティを確保する。

#### 受け入れ基準

1. When ユーザーがログアウトボタンをクリックする, 認可機能 shall ユーザーのセッションを終了する
2. When ユーザーがログアウトボタンをクリックする, 認可機能 shall 保存されている認可トークンを削除する
3. When ログアウト処理が完了する, 認可機能 shall ユーザーをログイン画面へリダイレクトする
4. 認可機能 shall ログアウト後、以前のセッショントークンでのアクセスを拒否する

### 要件5: パスワードポリシー

**目的:** システム管理者として、強力なパスワードポリシーを適用したい。
これにより、ブルートフォース攻撃や推測攻撃からアカウントを保護する。

#### 受け入れ基準

1. When ユーザーがパスワードを設定または変更する, 認可機能 shall パスワードが最低8文字以上であることを検証する
2. When ユーザーがパスワードを設定または変更する, 認可機能 shall パスワードに大文字・小文字・数字・記号のうち3種類以上が含まれることを検証する
3. If パスワードがポリシーを満たさない場合, then 認可機能 shall 具体的な要件を示すエラーメッセージを表示する
4. 認可機能 shall パスワード強度インジケーターを表示する

### 要件6: 認可状態の永続化

**目的:** 医療従事者として、ブラウザを閉じても一定期間ログイン状態を維持したい。
これにより、頻繁な再ログインの手間を省く。

#### 受け入れ基準

1. When ユーザーがログインする, 認可機能 shall 認可トークンをlocalStorageまたはsecure cookieに保存する
2. When ユーザーがブラウザを再度開く, 認可機能 shall 保存されたトークンの有効性を検証する
3. If 保存されたトークンが有効な場合, then 認可機能 shall ユーザーを自動的に認可済み状態にする
4. If 保存されたトークンが無効または期限切れの場合, then 認可機能 shall ユーザーをパスワード入力画面へリダイレクトする

---

## 非機能要件

### セキュリティ

- The 認可機能 shall すべての認可通信をHTTPS経由で行う
- The 認可機能 shall パスワードを平文で保存・送信しない
- The 認可機能 shall CSRF保護を実装する
- The 認可機能 shall 認可関連のイベント（ログイン成功/失敗、ログアウト）をログに記録する

### パフォーマンス

- The 認可機能 shall ログイン処理を2秒以内に完了する
- The 認可機能 shall トークン検証を100ms以内に完了する

---

## 用語定義

| 用語 | 定義 |
|------|------|
| 認可（Authorization） | システムユーザーに対するアクセス権限の制御 |
| JWT | JSON Web Token、認可トークンの形式 |
| アクセストークン | APIリクエストの認可に使用する短期トークン |
| リフレッシュトークン | アクセストークンの更新に使用する長期トークン |

---

**ステータス:** レビュー待ち
**作成日:** 2025-12-07
**最終更新:** 2025-12-07

