# 要件定義書: 診察詳細表示機能 (diagnosis-viewer)

## はじめに

本ドキュメントは、ECG心筋梗塞リスク推論システムにおける診察詳細表示機能の要件を定義する。
本機能は、診察一覧から選択された診察データについて、患者情報・心電図・推論結果を一画面で統合表示する
フロントエンド機能である。

**責務境界:**
- **diagnosis-viewer（本機能）**: 診察詳細の表示、患者情報表示、心電図可視化、推論結果表示、推論実行
- **diagnosis-list**: 診察選択（本機能への遷移トリガー）
- **ecg-mi-inferencer（別途定義）**: 心電図波形解析、心筋梗塞リスク推論実行、推論結果の返却
- **file-importer**: 診察データ・患者データのDB登録（本機能のデータソース）

**関連ユースケース:**
- UC-4: システムユーザーは診察データを選択し、結果・患者データ・心電図を参照できる
- UC-4-extend: システムはシステムユーザーの診察データ選択時に、心筋梗塞推論を実行する
- Core Capability 5: 統合結果表示（患者情報・心電図・推論結果を一画面で確認）

**技術選定:** React（MVVMアーキテクチャ）、TanStack Query（サーバー状態管理）、Orval（API型定義）、Chart.js/Recharts（心電図可視化）

## 要件一覧

### 要件1: 診察詳細の取得と表示

**目的:** 医療従事者として、選択した診察の詳細情報を確認したい。
これにより、診察に紐づく全ての情報を一括して把握できる。

#### 受け入れ基準

1. When 診察一覧画面から診察が選択される, 診察詳細表示機能 shall 診察UUIDをパラメータとして受け取る
2. When 診察詳細画面にアクセスする, 診察詳細表示機能 shall バックエンドAPIから診察データを取得する
3. 診察詳細表示機能 shall 診察UUIDをクエリパラメータまたはルートパラメータとして受け取る
4. When データ取得中, 診察詳細表示機能 shall ローディングインジケーターを表示する
5. When データ取得に失敗した場合, 診察詳細表示機能 shall エラーメッセージを表示する
6. When 診察データが存在しない場合, 診察詳細表示機能 shall 「診察データが見つかりません」というメッセージを表示する

### 要件2: 患者情報の表示

**目的:** 医療従事者として、診察に紐づく患者情報を確認したい。
これにより、患者の基本情報を把握し、診断判断の参考とすることができる。

#### 受け入れ基準

1. 診察詳細表示機能 shall 以下の患者情報を表示する：患者ID（外部ID）、患者氏名、生年月日、年齢、性別
2. 診察詳細表示機能 shall 患者情報セクションを画面上部に表示する
3. 診察詳細表示機能 shall 患者情報をカード形式または表形式で視覚的に整理して表示する
4. 診察詳細表示機能 shall 年齢を生年月日から自動計算して表示する

### 要件3: 診察情報の表示

**目的:** 医療従事者として、診察の基本情報を確認したい。
これにより、検査日時や関連情報を把握できる。

#### 受け入れ基準

1. 診察詳細表示機能 shall 以下の診察情報を表示する：検査日時、診察UUID、登録日時
2. 診察詳細表示機能 shall 診察情報を患者情報セクションの下に表示する
3. 診察詳細表示機能 shall 検査日時を「YYYY-MM-DD HH:mm:ss」形式で表示する

### 要件4: 心電図波形の可視化表示

**目的:** 医療従事者として、心電図波形データを視覚的に確認したい。
これにより、心電図のパターンを直接確認し、推論結果と照合できる。

#### 受け入れ基準

1. 診察詳細表示機能 shall 心電図波形データをグラフ形式で表示する
2. 診察詳細表示機能 shall CSVファイルから心電図波形データを読み込んで表示する
3. 診察詳細表示機能 shall 12誘導心電図を全て表示する（I, II, III, aVR, aVL, aVF, V1-V6）
4. 診察詳細表示機能 shall 各誘導を縦方向に配置し、時系列データを横軸に表示する
5. 診察詳細表示機能 shall サンプリングレート情報を表示する
6. 診察詳細表示機能 shall 心電図データの読み込み中にローディングインジケーターを表示する
7. When 心電図データが存在しない場合, 診察詳細表示機能 shall 「心電図データがありません」というメッセージを表示する
8. 診察詳細表示機能 shall 心電図波形のズーム・パン操作を提供する
9. 診察詳細表示機能 shall 表示範囲のリセットボタンを提供する

### 要件5: 推論結果の表示

**目的:** 医療従事者として、AIによる心筋梗塞リスク推論結果を確認したい。
これにより、客観的なリスク評価を参考に診断判断を支援できる。

#### 受け入れ基準

1. 診察詳細表示機能 shall 推論ステータス（未実行/実行中/完了/エラー）を表示する
2. 診察詳細表示機能 shall 推論ステータスが「完了」の場合、推論結果を表示する
3. 診察詳細表示機能 shall 推論結果に以下の情報を含める：リスクスコア（0-100%）、リスクレベル（低/中/高）、推論実行日時
4. 診察詳細表示機能 shall リスクレベルを視覚的なバッジ（低：グリーン、中：イエロー、高：レッド）で表示する
5. 診察詳細表示機能 shall リスクスコアをプログレスバーまたはゲージチャートで表示する
6. When 推論ステータスが「未実行」または「エラー」の場合, 診察詳細表示機能 shall 「推論実行」ボタンを表示する
7. When 推論ステータスが「実行中」の場合, 診察詳細表示機能 shall 進行状況インジケーターを表示する
8. When 推論結果が存在する場合, 診察詳細表示機能 shall 推論結果セクションを診察情報の下に表示する

### 要件6: 推論実行機能

**目的:** 医療従事者として、未実行の診察に対して心筋梗塞リスク推論を実行したい。
これにより、AIによるリスク評価を得て診断判断の参考とすることができる。

#### 受け入れ基準

1. 診察詳細表示機能 shall 「推論実行」ボタンを診察詳細画面に表示する（推論ステータスが「未実行」または「エラー」の場合）
2. When 「推論実行」ボタンがクリックされる, 診察詳細表示機能 shall 確認ダイアログを表示する
3. When 確認ダイアログで「実行」が選択される, 診察詳細表示機能 shall ecg-mi-inferencerサービスを呼び出す
4. 診察詳細表示機能 shall 診察UUIDをecg-mi-inferencerに渡す
5. When 推論実行が開始される, 診察詳細表示機能 shall 推論ステータスを「実行中」に更新する
6. 診察詳細表示機能 shall 推論実行中は「推論実行」ボタンを無効化する
7. When 推論が完了する, 診察詳細表示機能 shall 推論結果を取得し表示を更新する
8. When 推論がエラー終了する, 診察詳細表示機能 shall エラーメッセージを表示する
9. 診察詳細表示機能 shall 推論実行中に定期的（5秒間隔）にステータスをポーリングして更新する

### 要件7: データ自動更新

**目的:** 医療従事者として、推論実行中に最新のステータスを自動的に確認したい。
これにより、推論完了を待たずに最新情報を把握できる。

#### 受け入れ基準

1. When 推論ステータスが「実行中」の場合, 診察詳細表示機能 shall 自動的にステータスをポーリングする（5秒間隔）
2. When 推論ステータスが「完了」または「エラー」に変化した場合, 診察詳細表示機能 shall ポーリングを停止する
3. When 画面がフォーカス状態に戻る（タブ切り替え後等）, 診察詳細表示機能 shall 診察データを再取得する

### 要件8: ナビゲーション機能

**目的:** 医療従事者として、診察詳細画面から他の画面へ遷移したい。
これにより、診察一覧に戻るなどの操作ができる。

#### 受け入れ基準

1. 診察詳細表示機能 shall 「診察一覧に戻る」ボタンを提供する
2. When 「診察一覧に戻る」ボタンがクリックされる, 診察詳細表示機能 shall 診察一覧画面へ遷移する
3. 診察詳細表示機能 shall ブラウザの戻るボタンでも診察一覧画面に戻れるようにする

---

## 非機能要件

### パフォーマンス

- 診察詳細表示機能 shall 診察データ取得から表示までを2秒以内に完了する
- 診察詳細表示機能 shall 心電図データの読み込みから表示までを3秒以内に完了する
- 診察詳細表示機能 shall 推論結果の表示を1秒以内に完了する

### ユーザビリティ

- 診察詳細表示機能 shall 心電図波形が読みやすいように適切な色と線の太さを使用する
- 診察詳細表示機能 shall 各セクション（患者情報、診察情報、心電図、推論結果）を明確に区別して表示する
- 診察詳細表示機能 shall 重要な情報（リスクレベル、リスクスコア）を目立つように表示する

### セキュリティ

- 診察詳細表示機能 shall 認可トークン（JWT）をリクエストヘッダーに含めてAPIを呼び出す
- 診察詳細表示機能 shall 認可トークンが無効な場合、ログイン画面へリダイレクトする
- 診察詳細表示機能 shall 患者情報を含むログを出力しない

---

## データモデル概要

### 診察詳細APIレスポンス

| フィールド | 型 | 説明 |
|------------|------|------|
| `id` | UUID | 診察ID |
| `exam_date` | DateTime | 検査日時 |
| `mfer_file_path` | String | MFERファイルのパス |
| `created_at` | DateTime | 登録日時 |
| `patient` | Object | 患者情報 |
| `patient.id` | UUID | 患者ID |
| `patient.external_id` | String | 患者外部ID（MFER内のID） |
| `patient.name` | String | 患者氏名 |
| `patient.gender` | String | 性別（男性/女性） |
| `patient.birth_date` | Date | 生年月日 |
| `inference` | Object | 推論結果（null許容） |
| `inference.status` | String | 推論ステータス（未実行/実行中/完了/エラー） |
| `inference.risk_score` | Float | リスクスコア（0.0-100.0） |
| `inference.risk_level` | String | リスクレベル（低/中/高） |
| `inference.executed_at` | DateTime | 推論実行日時 |
| `csv_file_path` | String | CSVファイルのパス（心電図波形データ） |

### 推論実行APIリクエスト

| パラメータ | 型 | 必須 | 説明 |
|------------|------|------|------|
| `examination_id` | UUID | ✓ | 診察ID |

### 推論実行APIレスポンス

| フィールド | 型 | 説明 |
|------------|------|------|
| `status` | String | 推論ステータス（実行中/完了/エラー） |
| `examination_id` | UUID | 診察ID |

---

## アーキテクチャ境界図

```mermaid
flowchart TB
    subgraph FE["Frontend (React/MVVM)"]
        direction TB
        subgraph View["View Layer"]
            DV["診察詳細画面<br/>DiagnosisViewer.tsx"]
            ECG["心電図可視化<br/>ECGWaveform.tsx"]
            INF["推論結果表示<br/>InferenceResult.tsx"]
        end

        subgraph VM["ViewModel Layer"]
            UDV["useDiagnosisDetail.ts<br/>状態管理・API呼び出し"]
            UECG["useECGData.ts<br/>心電図データ読み込み"]
            UINF["useInference.ts<br/>推論実行・結果取得"]
        end

        subgraph Model["Model Layer"]
            API["API Client<br/>(Orval生成)"]
            DT["Domain Types"]
        end

        View --> VM
        VM --> Model
    end

    subgraph BE["Backend (FastAPI)"]
        EP1["GET /api/examinations/:id<br/>診察詳細取得"]
        EP2["POST /api/inferences<br/>推論実行"]
        EP3["GET /api/inferences/:id<br/>推論結果取得"]
        ES["ExaminationService<br/>InferenceService"]
    end

    subgraph INF["ecg-mi-inferencer（別途定義）"]
        RUN["推論実行"]
        RESULT["推論結果返却"]
    end

    subgraph Storage["ストレージ"]
        DB[(PostgreSQL)]
        FS["ファイルシステム<br/>(CSV/画像)"]
    end

    API --> EP1
    API --> EP2
    API --> EP3
    EP1 --> ES
    EP2 --> ES
    EP3 --> ES
    ES --> DB
    EP2 --> INF
    INF --> DB
    INF --> FS
    UECG --> FS
```

---

## UIモック（主要画面構成）

```text
┌─────────────────────────────────────────────────────────┐
│  [← 診察一覧に戻る]                     診察詳細        │
├─────────────────────────────────────────────────────────┤
│  [患者情報]                                             │
│  患者ID: P-001    氏名: 山田太郎    性別: 男性          │
│  生年月日: 1950-01-15    年齢: 75歳                    │
├─────────────────────────────────────────────────────────┤
│  [診察情報]                                             │
│  検査日時: 2025-12-07 14:30:00                         │
│  診察ID: 123e4567-e89b-12d3-a456-426614174000          │
├─────────────────────────────────────────────────────────┤
│  [推論結果]                      [推論実行]             │
│  ステータス: ● 完了                                     │
│  リスクスコア: ████████░░ 78%                          │
│  リスクレベル: [高] レッドバッジ                       │
│  推論実行日時: 2025-12-07 14:35:00                     │
├─────────────────────────────────────────────────────────┤
│  [心電図波形]                                           │
│  ┌─────────────────────────────────────────────┐       │
│  │ I:    ────╱╲────                            │       │
│  │ II:   ───╱╲───                              │       │
│  │ III:  ──╱╲──                                │       │
│  │ aVR:  ─╱╲─                                  │       │
│  │ ...   (12誘導全て表示)                      │       │
│  │ [ズーム] [パン] [リセット]                  │       │
│  └─────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────┘
```

---

## 用語定義

| 用語 | 定義 |
|------|------|
| 診察詳細 | 1回の心電図検査に対応する全ての情報（患者情報、診察情報、心電図、推論結果） |
| 心電図波形 | CSVファイルに保存された時系列の心電図データ |
| 12誘導 | 心電図の標準的な12個の測定位置（I, II, III, aVR, aVL, aVF, V1-V6） |
| 推論結果 | AIによる心筋梗塞リスク推論の出力（リスクスコア、リスクレベル） |
| リスクスコア | 0-100%の数値で表される心筋梗塞リスクの程度 |
| リスクレベル | リスクスコアに基づく分類（低/中/高） |
| ecg-mi-inferencer | 心電図波形を解析し心筋梗塞リスクを推論するサービス |

---

**ステータス:** レビュー待ち
**作成日:** 2025-12-07
**最終更新:** 2025-12-07

